{% extends 'frame.html' %}
{% block content %}
    {% load static %}
    {% load crispy_forms_tags %}
    <!-- Problem Header -->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <h1 class="display-5 fw-bold mb-2">{{ problem.title }}</h1>
                <p class="muted-white mb-4">
                    Posted by <span class="accent">{{ problem.author }}</span> | {{ problem.created_date }}
                </p>
            </div>
        </div>
        <!-- Problem Meta Info -->
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="card mybg-l h-100">
                            <div class="card-body text-center">
                                <small class="muted-white text-uppercase">Industry</small>
                                <p class="fw-bold mb-0 accent">{{ problem.get_industry_display }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card mybg-l h-100">
                            <div class="card-body text-center">
                                <small class="muted-white text-uppercase">Pain Level</small>
                                <p class="fw-bold mb-0 accent">{{ problem.pain_level }} / 10</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card mybg-l h-100">
                            <div class="card-body text-center">
                                <small class="muted-white text-uppercase">Affected People</small>
                                <p class="fw-bold mb-0 accent">{{ problem.get_affected_people_display }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card mybg-l h-100">
                            <div class="card-body text-center">
                                <small class="muted-white text-uppercase">Job Role</small>
                                <p class="fw-bold mb-0 accent">{{ problem.job_role }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Additional meta row -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="card mybg-l">
                            <div class="card-body text-center">
                                <small class="muted-white text-uppercase">Frequency</small>
                                <p class="fw-bold mb-0 accent">{{ problem.get_frequency_display }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card mybg-l">
                            <div class="card-body text-center">
                                <small class="muted-white text-uppercase">Status</small>
                                <p class="fw-bold mb-0">
                                    {% if problem.is_solved %}
                                        <span class="text-success">Solved</span>
                                    {% else %}
                                        <span class="text-warning">Unsolved</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card mybg-l">
                            <div class="card-body text-center">
                                <small class="muted-white text-uppercase">Takes</small>
                                <p class="fw-bold mb-0 accent">
                                    <i class="far fa-comments"></i> {{ takes_count }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card mybg-l">
                            <div class="card-body text-center">
                                <small class="muted-white text-uppercase">Contact</small>
                                <p class="fw-bold mb-0 accent">
                                    {% if problem.contact_info %}
                                        {{ problem.contact_info }}
                                    {% else %}
                                        None Shared
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Problem Description & Workaround -->
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <div class="card mybg-l mb-4">
                    <div class="card-body">
                        <h2 class="h4 fw-bold accent mb-3">Problem Description</h2>
                        <div class="card-text muted-white">{{ problem.description | safe }}</div>
                    </div>
                </div>
                {% if problem.workaround %}
                    <div class="card mybg-l mb-4">
                        <div class="card-body">
                            <h2 class="h4 fw-bold accent mb-3">Current Workaround</h2>
                            <div class="card-text muted-white">{{ problem.workaround | safe }}</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- Edit button -->
        <div class="row justify-content-center">
            <div class="col-12 col-md-10 mb-3">
                {% if user.is_authenticated and user == problem.author %}
                    <a href="{% url 'edit_problem' problem.slug %}"
                       class="btn btn-edit btn-sm">Edit Problem</a>
                {% endif %}
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <hr>
            </div>
        </div>
        <!-- Displaying Takes -->
        <div class="row">
            <div class="col-md-5 mb-4  mt-3 me-auto">
                <h3>Takes:</h3>
                <div class="card-body">
                    <!-- We want a for loop inside the empty control tags
                         to iterate through each take in takes -->
                    {% if not takes %}
                        <p>No Takes yet</p>
                    {% else %}
                        {% for take in takes %}
                            <div class="col-12 mb-4">
                                <div class="card {% if take.status != 'public' and take.author == user %} faded{% elif take.status != 'public' %} d-none{% endif %} h-100">
                                    <div class="card-body d-flex flex-column">
                                        <!-- Author & Date -->
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <span class="fw-bold accent">{{ take.author }}</span>
                                            <small class="muted-white">{{ take.created_date }}</small>
                                        </div>
                                        <!-- Description -->
                                        <p id="take{{ take.id }}" class="card-text muted-white flex-grow-1">{{ take.description }}</p>
                                        <!-- Hidden raw values for JS edit -->
                                        <span id="pain{{ take.id }}" class="d-none">{{ take.pain_level }}</span>
                                        <span id="freq{{ take.id }}" class="d-none">{{ take.frequency }}</span>
                                        <span id="affected{{ take.id }}" class="d-none">{{ take.affected_people }}</span>
                                        <!-- Meta fields -->
                                        <div class="d-flex flex-wrap gap-2 mt-auto">
                                            <span class="badge bg-secondary">Pain: {{ take.pain_level }}/10</span>
                                            <span class="badge bg-secondary">{{ take.get_frequency_display }}</span>
                                            <span class="badge bg-secondary">{{ take.get_affected_people_display }}</span>
                                        </div>
                                        <!-- Actions (only for take author) -->
                                        {% if user.is_authenticated and take.author == user %}
                                            <div class="mt-3">
                                                <button class="btn btn-edit btn-sm" data-take_id="{{ take.id }}">Edit</button>
                                                <button class="btn btn-delete btn-sm" data-take_id="{{ take.id }}">Delete</button>
                                            </div>
                                        {% endif %}
                                        {% if not take.status == 'public' and take.author == user %}
                                            <p class="approval mt-2 mb-0">
                                                <small>This take is awaiting approval</small>
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            <!-- Creating New Takes -->
            <div class="col-md-6 mb-4 p-4 mt-3">
                <div class="card-body">
                    {% if user.is_authenticated %}
                        <h3>Leave a Take:</h3>
                        <p>Posting as: {{ user.username }}</p>
                        <form id="takeForm" method="post"  style="margin-top: 1.3em">
                            {{ take_form | crispy }}
                            {% csrf_token %}
                            <button id="submitButton" type="submit" class="btn btn-signup btn-lg">Submit</button>
                        </form>
                    {% else %}
                        <p>Log in to leave a Take</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Delete confirmation modal -->
    <div class="modal fade"
         id="deleteModal"
         tabindex="-1"
         aria-labelledby="deleteModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Delete take?</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete your take?
                    This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a id="deleteConfirm" href="#" class="btn btn-danger">Delete</a>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extras %}
    <script src="{% static 'js/takes.js' %}"></script>
{% endblock extras %}
